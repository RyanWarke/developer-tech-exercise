<template>
  <div id="app">
    <Loading v-if="loading" />
    <div v-else class="max-w-7xl mx-auto">
      <div v-if="notLinked" class="py-12 flex flex-col justify-center items-center h-screen">
        <div class="bg-gray-50 p-8 rounded-3xl flex flex-col justify-center items-center border">
          <svg width="131" height="32" viewBox="0 0 131 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.2991 0C8.77743 0 4.32222 0.666667 0 2V16.6667C0 24.3333 5.31965 29.4667 13.2991 32C21.2786 29.4667 26.5983 24.3333 26.5983 16.6667V2C22.276 0.666667 17.8208 0 13.2991 0ZM19.9487 3.33333V16L13.2991 12L6.64957 16V3.33333C8.64443 2.66667 13.2991 2.66667 13.2991 2.66667C13.2991 2.66667 17.9538 2.66667 19.9487 3.33333ZM13.2991 29.2C10.4398 28.2667 7.84649 26.6667 5.71863 24.5333L13.2991 19.9333L20.8796 24.5333C18.7518 26.6667 16.1584 28.2667 13.2991 29.2Z" fill="#4368FA"></path>
            <path d="M54.9919 8.6665H60.112L54.9919 24.6665H50.5367L48.0098 16.1332L45.483 24.6665H41.0278L35.9741 8.6665H41.0278L43.3551 17.2665L45.8155 8.6665H50.2707L52.731 17.2665L54.9919 8.6665Z" fill="#27325E"></path>
            <path d="M74.2092 22.6664C70.9509 25.9997 65.6312 25.9997 62.3064 22.733C60.7106 21.133 59.7796 18.933 59.8461 16.6664C59.8461 11.9997 63.5699 8.19971 68.2246 8.19971C72.8793 8.19971 76.6695 11.933 76.6695 16.5997V16.6664C76.6695 18.933 75.8051 21.0664 74.2092 22.6664ZM65.6312 19.3997C67.0941 20.7997 69.4215 20.7997 70.8179 19.3997C71.5493 18.6664 71.8818 17.6664 71.8818 16.6664C71.9483 15.6664 71.5493 14.6664 70.8179 13.933C69.355 12.533 67.0276 12.533 65.6312 13.933C64.8998 14.6664 64.5008 15.6664 64.5673 16.6664C64.5008 17.6664 64.8998 18.6664 65.6312 19.3997Z" fill="#27325E"></path>
            <path d="M87.8407 8.19988C89.4366 8.13322 90.966 8.79988 92.0964 9.93322C93.2933 11.2665 93.8918 12.9999 93.8253 14.7999V24.6665H89.0376V15.5332C89.1041 14.7332 88.8381 13.9332 88.2397 13.3999C87.7077 12.8666 86.9763 12.5999 86.2448 12.6666C85.4469 12.5999 84.6489 12.9332 84.1169 13.4666C83.5185 14.1332 83.2525 15.0665 83.319 15.9332V24.6665H78.5313V8.66655H83.319V10.1999C84.2499 8.86655 85.7793 8.19988 87.8407 8.19988Z" fill="#27325E"></path>
            <path d="M107.789 3.79993L112.577 2.2666V24.6666H107.789V23.1333C106.593 24.4666 104.864 25.1999 103.068 25.0666C101.007 25.0666 99.012 24.1999 97.6821 22.5999C96.2192 20.9333 95.4213 18.7999 95.4878 16.5999C95.4213 14.3999 96.2192 12.2666 97.6821 10.5999C99.012 8.99994 101.007 8.13327 103.068 8.13327C104.864 7.99993 106.593 8.73327 107.789 10.0666V3.79993ZM101.273 19.5333C102.802 20.9333 105.196 20.9333 106.726 19.5333C107.457 18.7999 107.856 17.7333 107.789 16.6666C107.856 15.5999 107.457 14.5999 106.726 13.7999C105.196 12.3999 102.802 12.3999 101.273 13.7999C100.541 14.5333 100.142 15.5999 100.209 16.6666C100.209 17.7333 100.541 18.7333 101.273 19.5333Z" fill="#27325E"></path>
            <path d="M119.493 18.5999C120.025 20.0665 121.288 20.8665 123.283 20.8665C124.413 20.9332 125.544 20.4665 126.342 19.6665L130.132 21.8665C128.536 24.0665 126.275 25.1332 123.216 25.1332C120.823 25.2665 118.562 24.3999 116.833 22.7332C115.237 21.1332 114.372 18.9332 114.439 16.6665C114.306 12.1332 117.83 8.3332 122.352 8.19987C122.551 8.19987 122.684 8.19987 122.884 8.19987C125.078 8.1332 127.14 8.99987 128.669 10.5999C130.198 12.1999 131.063 14.3999 130.996 16.5999C130.996 17.2665 130.93 17.8665 130.797 18.5332L119.493 18.5999ZM119.426 14.9999H126.275C125.943 13.3999 124.48 12.3332 122.884 12.4665C121.022 12.4665 119.892 13.3332 119.426 14.9999Z" fill="#27325E"></path>
          </svg>
          <div class="my-6 p-4 rounded-xl bg-blue-500 text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="currentColor" viewBox="0 0 256 256">
              <path d="M209.94,113.94l-28,28a47.76,47.76,0,0,1-26.52,13.48,47.76,47.76,0,0,1-13.48,26.52l-28,28a48,48,0,0,1-67.88-67.88l28-28a47.76,47.76,0,0,1,26.52-13.48,47.76,47.76,0,0,1,13.48-26.52l28-28a48,48,0,0,1,67.88,67.88Z" opacity="0.2"></path><path d="M137.54,186.36a8,8,0,0,1,0,11.31l-17.94,18A56,56,0,0,1,40.38,136.4L68.5,108.29A56,56,0,0,1,145.31,106a8,8,0,1,1-10.64,12,40,40,0,0,0-54.85,1.63L51.7,147.72a40,40,0,1,0,56.58,56.58l17.94-17.94A8,8,0,0,1,137.54,186.36Zm78.08-146a56.08,56.08,0,0,0-79.22,0L118.46,58.33a8,8,0,0,0,11.32,11.31L147.72,51.7a40,40,0,0,1,56.58,56.58L176.18,136.4A40,40,0,0,1,121.33,138,8,8,0,1,0,110.69,150a56,56,0,0,0,76.81-2.27l28.12-28.11A56.08,56.08,0,0,0,215.62,40.38Z"></path>
            </svg>
          </div>
          <div v-if="!linkingSchool" class="text-center">
            <h1 class="font-black text-lg mb-2">Your School data has not been linked yet.</h1>
            <h2 class="font-bold text-gray-500 mb-6">Click on the 'Link School' button below to link your School and sync your data.</h2>
            <button type="button" @click="linkSchool" class="bg-blue-500 px-4 py-2 rounded-lg text-white hover:bg-blue-700">
              Link School
            </button>
          </div>
          <div v-else class="text-center">
            <h1 class="font-black text-lg mb-2">Your School data link has been requested.</h1>
            <h2 class="font-bold text-gray-500 mb-6">This sync may take a while on initial load. Please check back soon.</h2>
          </div>
        </div>
      </div>
      <div v-else>
        <div class="mb-10 mx-10">
          <div class="w-full py-12">
            <a href="https://www.wonde.com/" class="logo" title="Wonde logo">
              <svg width="131" height="32" viewBox="0 0 131 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.2991 0C8.77743 0 4.32222 0.666667 0 2V16.6667C0 24.3333 5.31965 29.4667 13.2991 32C21.2786 29.4667 26.5983 24.3333 26.5983 16.6667V2C22.276 0.666667 17.8208 0 13.2991 0ZM19.9487 3.33333V16L13.2991 12L6.64957 16V3.33333C8.64443 2.66667 13.2991 2.66667 13.2991 2.66667C13.2991 2.66667 17.9538 2.66667 19.9487 3.33333ZM13.2991 29.2C10.4398 28.2667 7.84649 26.6667 5.71863 24.5333L13.2991 19.9333L20.8796 24.5333C18.7518 26.6667 16.1584 28.2667 13.2991 29.2Z" fill="#4368FA"></path>
                <path d="M54.9919 8.6665H60.112L54.9919 24.6665H50.5367L48.0098 16.1332L45.483 24.6665H41.0278L35.9741 8.6665H41.0278L43.3551 17.2665L45.8155 8.6665H50.2707L52.731 17.2665L54.9919 8.6665Z" fill="#27325E"></path>
                <path d="M74.2092 22.6664C70.9509 25.9997 65.6312 25.9997 62.3064 22.733C60.7106 21.133 59.7796 18.933 59.8461 16.6664C59.8461 11.9997 63.5699 8.19971 68.2246 8.19971C72.8793 8.19971 76.6695 11.933 76.6695 16.5997V16.6664C76.6695 18.933 75.8051 21.0664 74.2092 22.6664ZM65.6312 19.3997C67.0941 20.7997 69.4215 20.7997 70.8179 19.3997C71.5493 18.6664 71.8818 17.6664 71.8818 16.6664C71.9483 15.6664 71.5493 14.6664 70.8179 13.933C69.355 12.533 67.0276 12.533 65.6312 13.933C64.8998 14.6664 64.5008 15.6664 64.5673 16.6664C64.5008 17.6664 64.8998 18.6664 65.6312 19.3997Z" fill="#27325E"></path>
                <path d="M87.8407 8.19988C89.4366 8.13322 90.966 8.79988 92.0964 9.93322C93.2933 11.2665 93.8918 12.9999 93.8253 14.7999V24.6665H89.0376V15.5332C89.1041 14.7332 88.8381 13.9332 88.2397 13.3999C87.7077 12.8666 86.9763 12.5999 86.2448 12.6666C85.4469 12.5999 84.6489 12.9332 84.1169 13.4666C83.5185 14.1332 83.2525 15.0665 83.319 15.9332V24.6665H78.5313V8.66655H83.319V10.1999C84.2499 8.86655 85.7793 8.19988 87.8407 8.19988Z" fill="#27325E"></path>
                <path d="M107.789 3.79993L112.577 2.2666V24.6666H107.789V23.1333C106.593 24.4666 104.864 25.1999 103.068 25.0666C101.007 25.0666 99.012 24.1999 97.6821 22.5999C96.2192 20.9333 95.4213 18.7999 95.4878 16.5999C95.4213 14.3999 96.2192 12.2666 97.6821 10.5999C99.012 8.99994 101.007 8.13327 103.068 8.13327C104.864 7.99993 106.593 8.73327 107.789 10.0666V3.79993ZM101.273 19.5333C102.802 20.9333 105.196 20.9333 106.726 19.5333C107.457 18.7999 107.856 17.7333 107.789 16.6666C107.856 15.5999 107.457 14.5999 106.726 13.7999C105.196 12.3999 102.802 12.3999 101.273 13.7999C100.541 14.5333 100.142 15.5999 100.209 16.6666C100.209 17.7333 100.541 18.7333 101.273 19.5333Z" fill="#27325E"></path>
                <path d="M119.493 18.5999C120.025 20.0665 121.288 20.8665 123.283 20.8665C124.413 20.9332 125.544 20.4665 126.342 19.6665L130.132 21.8665C128.536 24.0665 126.275 25.1332 123.216 25.1332C120.823 25.2665 118.562 24.3999 116.833 22.7332C115.237 21.1332 114.372 18.9332 114.439 16.6665C114.306 12.1332 117.83 8.3332 122.352 8.19987C122.551 8.19987 122.684 8.19987 122.884 8.19987C125.078 8.1332 127.14 8.99987 128.669 10.5999C130.198 12.1999 131.063 14.3999 130.996 16.5999C130.996 17.2665 130.93 17.8665 130.797 18.5332L119.493 18.5999ZM119.426 14.9999H126.275C125.943 13.3999 124.48 12.3332 122.884 12.4665C121.022 12.4665 119.892 13.3332 119.426 14.9999Z" fill="#27325E"></path>
              </svg>
            </a>
          </div>

          <div class="flex justify-between items-center">
            <div>
              <h2 class="font-black text-lg">{{ school.name }}</h2>
              <div class="text-sm mt-2">
                <p>{{ school.address_line_1 }},</p>
                <p>{{ school.address_line_2 }},</p>
                <p>{{ school.town }}</p>
                <p>{{ school.postcode }}</p>
              </div>
            </div>
            <div class="text-sm text-right bg-gray-100 px-8 py-4 rounded-3xl">
              <h3 class="font-bold">Last Synced:</h3>
              <p class="mb-4">{{ resyncDate }}</p>
              <button type="button" @click="resyncData" class="underline">{{ resyncing ? 'Syncing...' : 'Resync Now' }}</button>
            </div>
          </div>
        </div>

        <router-view></router-view>
      </div>
    </div>
  </div>
</template>

<script>
import Loading from '@/components/Loading.vue';

export default {
  components: {
    Loading
  },
  data() {
    return {
      linkingSchool: false,
      loading: true,
      notLined: false,
      school: {
        name: '',
        address_line_1: '',
        address_line_2: '',
        town: '',
        postcode: '',
        updated_at: null
      },
      resyncing: false
    };
  },
  computed: {
    resyncDate() {
      if (this.school && this.school.updated_at) {
        // Convert to Date object
        const dateObj = new Date(this.school.updated_at);

        // Define options for formatting the date
        const options = {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric',
          hour12: false
        };

        return dateObj.toLocaleString('en-GB', options);
      }

      return 'School has never been synced'
    }
  },
  mounted() {
    this.axios.get('/api/school').then(response => {
      this.school = response.data;
    }).catch(() => {
      this.notLinked = true;
    }).finally(() => {
      this.loading = false;
    });
  },
  methods: {
    linkSchool() {
      this.linkingSchool = true;
      this.axios.post('/api/school/resync').then(() => {
        this.$toast.success('Link requested');
      });
    },
    resyncData() {
      this.resyncing = true;
      this.axios.post('/api/school/resync').then(() => {
        this.$toast.success('Resync requested');
      }).finally(() => {
        this.resyncing = false;
      });
    }
  }
}
</script>